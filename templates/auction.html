{% extends 'base.html' %}
{% block content %}

<div class="container-fluid auction-page">

<h2 class="title-glow text-center mb-3">IPL AUCTION DASHBOARD</h2>

<!-- ================= TOP BAR ================= -->
<div class="d-flex justify-content-center align-items-center gap-4 mb-4">

    <!-- UNSOLD COUNT -->
    <span class="badge bg-danger fs-6">
        UNSOLD ({{ category or 'All' }}): {{ unsold_count }}
    </span>

    <!-- RE-AUCTION UNSOLD ONLY -->
    <form method="get">
        <input type="hidden" name="category" value="{{ category }}">
        <input type="hidden" name="reauction" value="1">
        <button class="btn btn-outline-warning btn-sm">
            üîÅ Re-Auction UNSOLD
        </button>
    </form>

</div>

<!-- ================= CATEGORY SELECT ================= -->
<form method="get" class="mb-4 text-center">
    <select name="category" class="form-select d-inline w-auto">
        <option disabled {% if not category %}selected{% endif %}>Select Category</option>
        <option {% if category=='Batsman' %}selected{% endif %}>Batsman</option>
        <option {% if category=='Bowler' %}selected{% endif %}>Bowler</option>
        <option {% if category=='All-rounder' %}selected{% endif %}>All-rounder</option>
        <option {% if category=='Wicket-Keeper' %}selected{% endif %}>Wicket-Keeper</option>
    </select>
    <button class="btn btn-primary ms-2">Load</button>
</form>

{% if players %}
<div class="row auction-layout gx-4">

<!-- ================= LEFT : PLAYER LIST ================= -->
<div class="col-lg-3 auction-left">
    <div class="card queue-card">
        <h6 class="section-title">PLAYER QUEUE</h6>

        <table class="table table-sm mb-0">
            {% for p in players %}
            <tr class="player-row {% if current and p.id == current.id %}table-active{% endif %}"
                onclick="location.href='?category={{ category }}&player={{ p.id }}{% if request.args.get('reauction') %}&reauction=1{% endif %}'">

                <td class="fw-bold">
                    {{ loop.index }}. {{ p.name }}
                </td>

                <td class="text-end">
                    {% if p.status == 'SOLD' %}
                        <span class="badge bg-success">SOLD</span>
                    {% elif p.status == 'UNSOLD' %}
                        <span class="badge bg-secondary">UNSOLD</span>
                    {% else %}
                        <span class="badge bg-info">AVAILABLE</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </table>

    </div>
</div>

<!-- ================= CENTER : AUCTION PODIUM ================= -->
<div class="col-lg-6 d-flex justify-content-center align-items-center auction-center">

{% if current %}
<div class="card auction-podium square-podium">

    <img src="/static/players/{{ current.id }}.jpg"
         onerror="this.src='/static/players/default.png'"
         class="player-img">

    <h2 class="player-name">{{ current.name }}</h2>

    <div class="player-sub">
        {{ current.role }} ‚Ä¢ {{ current.nationality }}
    </div>

    <div class="base-price">
        BASE PRICE ‚Çπ{{ current.base_price }} Cr
    </div>

    <!-- AUCTION CONTROLS -->
    <div class="auction-controls">
        <button class="btn btn-outline-info"
            onclick="announcePlayer('{{ current.name }}','{{ current.base_price }}')">
            üéôÔ∏è Announce
        </button>
    </div>

    <!-- SOLD FORM -->
    <form method="post" action="/sell" onsubmit="return validateSell()">

        <input type="hidden" name="player_id" value="{{ current.id }}">
        <input type="hidden" name="category" value="{{ category }}">

        <input class="form-control mt-3" name="price"
               placeholder="Final Price (Cr)" required>

        <select class="form-select mt-2"
                name="team_id"
                id="teamSelect"
                required>
            <option value="" selected disabled>-- Select Team --</option>

            {% for t in teams %}
            <option value="{{ t.id }}"
                {% if t.disabled %}disabled{% endif %}>
                {{ t.name }}
                {% if t.disabled %}‚ùå ({{ t.reason }}){% endif %}
            </option>
            {% endfor %}
        </select>

        <button class="btn btn-success w-100 mt-3">
            üî® SOLD
        </button>
    </form>

    <!-- UNSOLD FORM -->
    <form method="post" action="/unsold">
        <input type="hidden" name="player_id" value="{{ current.id }}">
        <input type="hidden" name="category" value="{{ category }}">

        <button class="btn btn-secondary w-100 mt-2">
            ‚ùå UNSOLD
        </button>
    </form>

</div>
{% endif %}

</div>


<!-- ================= RIGHT : FULL STATS ================= -->
<div class="col-lg-3 auction-right">
{% if current %}
<div class="card stats-card">
    <h6 class="section-title">PLAYER STATS</h6>

    <div class="player-details">
        <div class="player-box"><span>Matches</span><strong>{{ current.matches }}</strong></div>

        {% if current.runs %}
        <div class="player-box"><span>Runs</span><strong>{{ current.runs }}</strong></div>
        {% endif %}

        {% if current.wickets %}
        <div class="player-box"><span>Wickets</span><strong>{{ current.wickets }}</strong></div>
        {% endif %}

        {% if current.strike_rate %}
        <div class="player-box"><span>Strike Rate</span><strong>{{ current.strike_rate }}</strong></div>
        {% endif %}

        {% if current.economy %}
        <div class="player-box"><span>Economy</span><strong>{{ current.economy }}</strong></div>
        {% endif %}

        {% if current.catches %}
        <div class="player-box"><span>Catches</span><strong>{{ current.catches }}</strong></div>
        {% endif %}
    </div>

    <hr>

    <h6 class="section-title">RATINGS</h6>
    <div class="player-details">
        <div class="player-box"><span>Form</span><strong>{{ current.form_rating }}/10</strong></div>
        <div class="player-box"><span>Fitness</span><strong>{{ current.fitness_rating }}/10</strong></div>
        <div class="player-box"><span>Consistency</span><strong>{{ current.consistency }}/10</strong></div>
    </div>
</div>
{% endif %}
</div>

</div>
{% endif %}

</div>
{% endblock %}
<script>
function validateSell() {
    const team = document.getElementById("teamSelect");
    if (!team.value) {
        alert("‚ö†Ô∏è Please select an eligible team before selling!");
        return false;
    }
    return true;
}
</script>
